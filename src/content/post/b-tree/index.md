---
title: "B-Tree & B+Tree设计思想"
publishDate: "17 Aug 2023"
description: "B树在数据库中的应用，及原理，为什么使用它"
tags: ["database","data-structure","b-tree"]
---
## B树及其变种的设计思想与实现

B树是一种自平衡的搜索树，广泛应用于数据库索引的实现中。相比于二叉搜索树，B树的查询效率更高，能够支持更大规模的数据存储。此外，B树的变种，如B+树、B*树等，也被广泛应用于数据库索引的设计中。

在数据库中，B树的设计与实现需要考虑多个因素。首先是B树的阶数，即每个节点最多能够存储的关键字数量。阶数的选择需要根据存储数据的规模和查询效率的要求来确定。其次是B树的平衡性维护，即在插入和删除操作中，如何保证树的平衡性，避免出现极端不平衡的情况。

B+树是一种常用的B树变种，其特点是在内部节点只存储关键字，而所有数据都存储在叶子节点中。这种设计可以提高数据查询的效率，减少磁盘I/O操作。此外，B+树还支持范围查询和顺序访问等操作，是一种非常高效的索引结构。

B*树是B+树的一种改进，其主要特点是引入了**节点分裂和合并**的策略，可以更加灵活地维护树的平衡性。B*树在某些情况下比B+树更加高效，但是其实现相对复杂，需要更多的计算和存储资源。

综上所述，B树及其变种在数据库中的设计与实现是一个复杂而重要的问题。选择适合的B树阶数和变种类型，以及合理的平衡性维护策略，能够极大地提高数据库的查询效率和存储容量。

### 页头

B树的页头一般包括若干个元数据信息，如B树的阶数、树的高度、根节点地址等。这些信息可以帮助数据库管理系统快速定位到B树的根节点，加速数据的查询和更新操作。

也通常包含页内容，布局的标志位，页中单元格的数量，标记空闲空间的上界与下界偏移量（用于追加单元格偏移量和数据），比如PostgreSQL会在头部存储页大小和布局版本。在MySQL InnoDB中，页头保存该页的记录总数、层数和其他一些与实现相关的值。在SQLite中，页头存储单元格的数量和最右指针。

### 魔数

文件或页头种经常放置的一个值是魔数，通常它是一个多字节快，包含一个常数值，表示该块代表一个页，并指定页的类型或标识其版本。

B+树没有具体的魔数。魔数指的是特定的固定数值，用于文件格式或数据结构的标识和校验。在B+树的实现中，一般会使用页头或者节点头中的标识信息来区分不同类型的节点，而不是使用固定的魔数。

在B树的实现中，一般会使用页头或者节点头中的标识信息来区分不同类型的节点，而不是使用固定的魔数。B+树没有具体的魔数。

### 分裂和合并

B树的分裂和合并操作是维护B树平衡性的重要手段。当一个节点中的关键字数量超过了阶数（最大关键字数量），就需要对该节点进行分裂操作。分裂操作会将该节点分成两个节点，并将其中一部分关键字上移至父节点中，以确保父节点中的关键字数量不超过阶数。

与分裂操作相反的是合并操作。当一个节点中的关键字数量低于阶数的一半时，就需要对该节点进行合并操作。合并操作会将该节点与其相邻的兄弟节点合并成一个节点，以减少B树的高度。

B+树和B*树的分裂和合并操作与B树类似，但有一些细节上的不同。例如，在B+树中，叶子节点之间会通过指针进行连接，因此在分裂和合并操作时需要额外考虑这些指针的变化。在B*树中，分裂和合并操作的策略更加灵活，可以根据具体情况选择不同的方式来维护树的平衡性。

### 同级指针

要定位一个同级节点，除非有指针指向同级节点，否则我们必须通过父节点才能定位。在页头中存储直接连接同级节点的指针，我们可以方便地通过这些指针来定位同一层上的前序或后继节点。

B树的同级指针是指相同父节点的兄弟节点之间的指针连接。这些指针可以加速B树节点的查找过程，特别是在进行范围查询和顺序访问时。在B+树中，同级指针只存在于叶子节点之间，而在B*树中，同级指针不仅存在于叶子节点之间，还存在于非叶子节点之间。同级指针的维护需要在节点的分裂和合并操作中进行，以确保B树的平衡性。

### 分隔键

B树的分隔键是指在一个节点中，用于划分左右子树的关键字。在B树的插入和删除操作中，需要根据分隔键来确定插入或删除的位置，并保证树的平衡性。在B+树和B*树中，分隔键的作用相同，但是在叶子节点中只存储数据，因此分隔键只存在于非叶子节点中。根据分隔键的选择，可以影响B树的查询效率和空间利用率。通常采用动态分隔键的方式，根据具体情况动态选择分隔键，以达到最优的查询效率和空间利用率。

在B树中，键指的是存储在节点中的关键字，用于进行数据查找和排序。每个节点包含多个键值，且这些键值之间存在着大小关系。在B树的插入和删除操作中，需要根据键值的大小关系来确定插入或删除的位置。在B+树和B*树中，键的定义与B树相同，但是在叶子节点中只存储数据，因此键只存在于非叶子节点中。根据键的选择，可以影响B树的查询效率和空间利用率。通常采用动态分隔键的方式，根据具体情况动态选择分隔键，以达到最优的查询效率和空间利用率。

节点的高键是指在一个节点中，键值最大的关键字。在B树的插入和删除操作中，需要根据高键来确定插入或删除的位置，并保证树的平衡性。在B+树和B*树中，高键的作用相同，但是在叶子节点中只存储数据，因此高键只存在于非叶子节点中。高键的选择可以影响B树的查询效率和空间利用率。通常采用动态高键的方式，根据具体情况动态选择高键，以达到最优的查询效率和空间利用率。

**节点的高键表示当前节点下的子树中可能存在的最高的键**，PostgreSQL使用了这种方法，称为**Blink树**

Blink trees are a variation of B-trees that were developed for use in high-speed networks. They are designed to reduce the number of I/O operations required to access data in a network environment. However, they are not commonly used in database indexing, and the concepts involved in their design and implementation are not as well-known as those of B-trees and their variants.

### 溢出页

节点带线啊哦和树扇出是固定并且不会动态改版的。如果树种存在变长值，并且他们足够大，那么页中只能放下少数几个值；如果值很小，我们最终会浪费保留的空间。

如果节点尚未满，当保存该节点固定大小的页上已经没有更多的空间了，调整页大小需要将已经写入的数据复制到新区域，这通常是不切实际的。

为了实现变长节点而无须将数据复制到新的连续区域，我们可以哦车那个多个链接起来的页中构建节点。我们可以为其分配一个扩展页，并且哦车那个原始页链接到它。这些链接起来的页被称为溢出页，原始页称为主页。
